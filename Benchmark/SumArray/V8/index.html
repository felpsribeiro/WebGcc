<!-- 
    rode o comando no terminal "python3 -m http.server"
    abra o navegador na porta aberta do servidor e abra este arquivo .html
-->

<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Teste velocidade Somador</title>
    <script src="./libs/lodash.js"></script>
    <script src="./libs/platform.js"></script>
    <script src="./libs/benchmark.js"></script>
    <style>
        body {
            background-color: black;
            color: white;
        }
    </style>
</head>

<body>
    <h1>Teste de velocidade</h1>
    <h2>Informações:</h2>
    <div id="info">Sistema: </div>
    <h2>Primeiro resultado: </h2>
    <div id="js-time">JS: </div>
    <div id="wa-time">WA: </div>
    <div id="wao4-time">WAO4: </div>
    <h2>Resultado final:</h2>
    <div id="js-result">Somador em JS: carregando... </div>
    <div id="js-mean"></div>
    <div id="js-deviation"></div>
    <br>
    <div id="wa-result">Somador em WA: carregando...</div>
    <div id="wa-mean"></div>
    <div id="wa-deviation"></div>
    <br>
    <div id="wao4-result">Somador em WA com otimização: carregando...</div>
    <div id="wao4-mean"></div>
    <div id="wao4-deviation"></div>
    <script type="text/javascript">
        const info = document.getElementById('info');
        info.textContent += Benchmark.platform;

        async function execute() {
            const QUANT = 1000000;

            const memory = new WebAssembly.Memory({ initial: 100 });
            const array = new Uint32Array(memory.buffer);

            const wasmInstance = await WebAssembly.instantiateStreaming(fetch("sumArray.wasm"), { js: { mem: memory } });
            const sumWA = wasmInstance.instance.exports.sum;

            const wasmO4Instance = await WebAssembly.instantiateStreaming(fetch("sumArrayO4.wasm"), { js: { mem: memory } });
            const sumWAO4 = wasmO4Instance.instance.exports.sum;

            function sum(array) {
                let sum = 0;
                for (let i = 0; i < array.length; i++) {
                    sum += array[i];
                }
                return sum;
            }

            for (let i = 0; i < QUANT; i++) {
                array[i] = 1;
            }

            let inicio = performance.now()
            sum(array);
            let fim = performance.now();
            document.getElementById('js-time').textContent += (fim - inicio).toFixed(3) + " ms";

            inicio = performance.now()
            sumWA(QUANT);
            fim = performance.now();
            document.getElementById('wa-time').textContent += (fim - inicio).toFixed(3) + " ms";

            inicio = performance.now()
            sumWA(QUANT);
            fim = performance.now();
            document.getElementById('wao4-time').textContent += (fim - inicio).toFixed(3) + " ms";

            const suite = new Benchmark.Suite;
            suite.add('Somador em JS', function () {
                sum(array);
            }).add('Somador em WA', function () {
                sumWA(QUANT);
            }).add('Somador em WA com otimização', function () {
                sumWAO4(QUANT);
            }).on('complete', function () {
                document.getElementById('js-result').textContent = "Somador em JS: " + this[0].toString();
                document.getElementById('js-mean').textContent = `Média: ${this[0].stats.mean * 1000} ms`;
                document.getElementById('js-deviation').textContent = `Desvio Padrão: ${this[0].stats.deviation * 1000000} µs`;

                document.getElementById('wa-result').textContent = "Somador em WA: " + this[1].toString();
                document.getElementById('wa-mean').textContent = `Média: ${ this[1].stats.mean * 1000 } ms`;
                document.getElementById('wa-deviation').textContent = `Desvio Padrão: ${ this[1].stats.deviation * 1000000 } µs`;

                document.getElementById('wao4-result').textContent = "Somador em WA O4: " + this[2].toString();
                document.getElementById('wao4-mean').textContent = `Média: ${this[2].stats.mean * 1000} ms`;
                document.getElementById('wao4-deviation').textContent = `Desvio Padrão::${this[2].stats.deviation * 1000000} µs`;
            }).run({ 'async': true });
        }
        execute();
    </script>
</body>

</html>